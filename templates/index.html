<!DOCTYPE html>
<html>

<head>
    <title>DeepGuard - Deteksi Deepfake</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
        }

        #realtime-container {
            position: relative;
        }

        #realtime-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .feature-card {
            height: 100%;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">DeepGuard AI</h1>
        <p class="text-center lead">Deteksi Deepfake Multi-Modal dengan Penjelasan AI</p>

        <!-- Fitur utama -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="card feature-card shadow-sm">
                    <div class="card-body text-center">
                        <h5 class="card-title">Deteksi Multi-Modal</h5>
                        <p class="card-text">Analisis gambar, video, dan audio untuk deteksi manipulasi</p>
                        <div class="text-primary"><i class="bi bi-layers-half" style="font-size: 2rem;"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card shadow-sm">
                    <div class="card-body text-center">
                        <h5 class="card-title">Analisis Real-Time</h5>
                        <p class="card-text">Pemrosesan cepat untuk deteksi instan</p>
                        <div class="text-success"><i class="bi bi-speedometer" style="font-size: 2rem;"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card shadow-sm">
                    <div class="card-body text-center">
                        <h5 class="card-title">Pertahanan Adversarial</h5>
                        <p class="card-text">Ketahanan terhadap teknik deepfake terbaru</p>
                        <div class="text-danger"><i class="bi bi-shield-check" style="font-size: 2rem;"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card shadow-sm">
                    <div class="card-body text-center">
                        <h5 class="card-title">Penjelasan & Kepercayaan</h5>
                        <p class="card-text">Visualisasi area yang dimanipulasi dengan skor kepercayaan</p>
                        <div class="text-info"><i class="bi bi-graph-up" style="font-size: 2rem;"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs untuk pilihan mode -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload"
                    type="button" role="tab">Upload File</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="realtime-tab" data-bs-toggle="tab" data-bs-target="#realtime" type="button"
                    role="tab">Deteksi Real-Time</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button"
                    role="tab">API</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="myTabContent">
            <!-- Upload Tab -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Upload Media</h5>
                                <form id="uploadForm" enctype="multipart/form-data" onsubmit="return checkFileSize()">
                                    <div class="mb-3">
                                        <label for="mediaFile" class="form-label">Pilih File (Gambar/Video)</label>
                                        <input class="form-control" type="file" id="mediaFile" name="file"
                                            accept="image/*,video/*">
                                        <p class="mb-1 text-danger">*batas maksimal ukuran file 10mb</p>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Analisis</button>
                                </form>

                                <div class="text-center mt-3 d-none" id="uploadLoader">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Menganalisis...</p>
                                </div>
                            </div>
                        </div>

                        <div class="card d-none" id="uploadResult">
                            <div class="card-body">
                                <h5 class="card-title">Hasil Analisis</h5>
                                <div class="alert" id="uploadVerdict"></div>

                                <div class="mb-3">
                                    <label class="form-label">Skor Kepercayaan</label>
                                    <div class="progress">
                                        <div class="progress-bar" id="uploadConfidence" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>Detail Analisis</h6>
                                    <table class="table table-sm">
                                        <tbody id="uploadDetails">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Visualisasi</h5>
                                <div class="text-center">
                                    <img id="uploadVisualization" class="img-fluid" alt="Visualization">
                                </div>
                                <div class="mt-3">
                                    <h6>Legenda</h6>
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <span class="badge bg-success">Hijau</span> Area Asli
                                        </div>
                                        <div>
                                            <span class="badge bg-warning">Kuning</span> Kemungkinan Dimanipulasi
                                        </div>
                                        <div>
                                            <span class="badge bg-danger">Merah</span> Manipulasi Terdeteksi
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Realtime Tab -->
            <div class="tab-pane fade" id="realtime" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Deteksi Real-Time</h5>
                                <p>Izinkan akses kamera untuk deteksi real-time.</p>
                                <button id="startCamera" class="btn btn-primary mb-3">Mulai Kamera</button>

                                <div id="realtime-container">
                                    <video id="video" width="100%" autoplay muted></video>
                                    <canvas id="realtime-overlay"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Analisis Real-Time</h5>
                                <div class="alert alert-secondary" id="realtimeStatus">
                                    Menunggu kamera...
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Probabilitas Deepfake</label>
                                    <div class="progress">
                                        <div class="progress-bar" id="realtimeScore" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>Detail</h6>
                                    <table class="table table-sm">
                                        <tbody id="realtimeDetails">
                                            <tr>
                                                <td>Status</td>
                                                <td>Menunggu data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Tab -->
            <div class="tab-pane fade" id="api" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Integrasi API</h5>
                        <p>DeepGuard menyediakan API REST yang dapat diintegrasikan dengan platform lain.</p>

                        <h6 class="mt-3">Endpoint</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <pre><code>POST /api/detect
Content-Type: multipart/form-data

file=[FILE_GAMBAR_ATAU_VIDEO]</code></pre>
                            </div>
                        </div>

                        <h6>Contoh Response</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <pre><code>{
  "result": {
    "verdict": "FAKE",
    "confidence": 0.89,
    "high_attention_areas_percent": 12.34,
    "detected_anomalies": ["inconsistent texture", "lighting issues"],
    "suspected_features": ["eye region", "cheek region"],
    "reliability_score": 0.85,
    "details": {
      "face_consistency": 0.45,
      "texture_analysis": 0.38,
      "lighting_score": 0.42
    }
  },
  "visualization": "data:image/jpeg;base64,..."
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        function checkFileSize() {
            const fileInput = document.getElementById('fileInput');
            const fileSize = fileInput.files[0].size; // in bytes
            const maxSize = 10 * 1024 * 1024; // 10 MB

            if (fileSize > maxSize) {
                alert('File size exceeds the maximum allowed limit of 10 MB');
                return false;
            }
            return true;
        }


        // Form upload handler
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const loader = document.getElementById('uploadLoader');
            const result = document.getElementById('uploadResult');

            // Show loader
            loader.classList.remove('d-none');
            result.classList.add('d-none');

            // Send to API
            fetch('/api/detect', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    // Hide loader
                    loader.classList.add('d-none');
                    result.classList.remove('d-none');

                    // Update UI
                    const verdict = document.getElementById('uploadVerdict');
                    verdict.textContent = data.result.verdict;
                    verdict.className = `alert ${data.result.verdict === 'FAKE' ? 'alert-danger' : 'alert-success'}`;

                    const confidence = document.getElementById('uploadConfidence');
                    const confidencePercent = data.result.confidence * 100;
                    confidence.style.width = `${confidencePercent}%`;
                    confidence.textContent = `${confidencePercent.toFixed(1)}%`;
                    confidence.className = `progress-bar ${data.result.verdict === 'FAKE' ? 'bg-danger' : 'bg-success'}`;

                    // Update details
                    document.getElementById('uploadDetails').innerHTML = `
                    <tr><td>Face Consistency</td><td>${data.result.details.face_consistency.toFixed(2)}</td></tr>
                    <tr><td>Texture Analysis</td><td>${data.result.details.texture_analysis.toFixed(2)}</td></tr>
                    <tr><td>Lighting Score</td><td>${data.result.details.lighting_score.toFixed(2)}</td></tr>
                    <tr><td>Anomalies</td><td>${data.result.detected_anomalies.join(', ') || 'None'}</td></tr>
                `;

                    // Update visualization
                    document.getElementById('uploadVisualization').src = data.visualization;
                })
                .catch(error => {
                    console.error('Error:', error);
                    loader.classList.add('d-none');
                    alert('Error processing file. Please try again.');
                });
        });

        // Real-time detection
        let realtimeProcessing = false;
        let captureInterval;

        document.getElementById('startCamera').addEventListener('click', function () {
            const video = document.getElementById('video');
            const status = document.getElementById('realtimeStatus');

            if (realtimeProcessing) {
                // Stop processing
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                clearInterval(captureInterval);
                realtimeProcessing = false;
                this.textContent = 'Mulai Kamera';
                status.textContent = 'Kamera berhenti';
                status.className = 'alert alert-secondary';
                return;
            }

            // Start camera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    realtimeProcessing = true;
                    this.textContent = 'Stop Kamera';
                    status.textContent = status.textContent = 'Kamera aktif, menganalisis...';
                    status.className = 'alert alert-info';

                    const canvas = document.createElement('canvas');

                    // Start capture loop
                    captureInterval = setInterval(() => {
                        if (!realtimeProcessing) return;

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        // Send frame for analysis
                        canvas.toBlob(blob => {
                            const formData = new FormData();
                            formData.append('frame', blob);
                            formData.append('id', Date.now().toString());

                            fetch('/api/realtime', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'processing') {
                                        // Check result after a short delay
                                        setTimeout(() => checkResult(data.id), 500);
                                    } else {
                                        updateRealtimeUI(data);
                                    }
                                })
                                .catch(error => {
                                    console.error('Real-time analysis error:', error);
                                    status.textContent = 'Error dalam analisis';
                                    status.className = 'alert alert-danger';
                                });
                        }, 'image/jpeg');
                    }, 1000); // Capture every second
                })
                .catch(error => {
                    console.error('Camera access error:', error);
                    status.textContent = 'Gagal mengakses kamera: ' + error.message;
                    status.className = 'alert alert-danger';
                });
        });

        function checkResult(taskId) {
            fetch(`/api/result/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'complete') {
                        updateRealtimeUI(data);
                    }
                })
                .catch(console.error);
        }

        function updateRealtimeUI(data) {
            if (!realtimeProcessing) return;

            const result = data.result;
            const status = document.getElementById('realtimeStatus');
            const score = document.getElementById('realtimeScore');
            const details = document.getElementById('realtimeDetails');

            // Update status
            status.textContent = result.verdict === 'FAKE' ?
                'PERINGATAN: Kemungkinan deepfake terdeteksi' :
                'Tampak asli';
            status.className = `alert ${result.verdict === 'FAKE' ? 'alert-danger' : 'alert-success'}`;

            // Update score
            const scorePercent = result.confidence * 100;
            score.style.width = `${scorePercent}%`;
            score.textContent = `${scorePercent.toFixed(1)}%`;
            score.className = `progress-bar ${result.verdict === 'FAKE' ? 'bg-danger' : 'bg-success'}`;

            // Update details
            details.innerHTML = `
                <tr><td>Status</td><td>Aktif</td></tr>
                <tr><td>Confidence</td><td>${(result.confidence * 100).toFixed(1)}%</td></tr>
                <tr><td>Face Consistency</td><td>${result.details.face_consistency.toFixed(2)}</td></tr>
                <tr><td>Texture Analysis</td><td>${result.details.texture_analysis.toFixed(2)}</td></tr>
                <tr><td>Lighting Score</td><td>${result.details.lighting_score.toFixed(2)}</td></tr>
            `;

            // Update overlay
            const overlay = document.getElementById('realtime-overlay');
            overlay.width = video.clientWidth;
            overlay.height = video.clientHeight;
            const ctx = overlay.getContext('2d');

            // Clear previous overlay
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            // Draw analysis visualization if suspicious
            if (result.verdict === 'FAKE') {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;

                // Draw boxes around suspected areas
                result.suspected_features.forEach(feature => {
                    const y = feature.includes('eye') ? 0.3 :
                        feature.includes('nose') ? 0.5 : 0.7;

                    ctx.strokeRect(
                        overlay.width * 0.3,
                        overlay.height * y,
                        overlay.width * 0.4,
                        overlay.height * 0.15
                    );
                });
            }
        }

        // Cleanup when switching tabs
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('show.bs.tab', e => {
                if (e.target.id !== 'realtime-tab' && realtimeProcessing) {
                    document.getElementById('startCamera').click(); // Stop camera
                }
            });
        });
    </script>
</body>

</html>